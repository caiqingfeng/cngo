# Golang calls c/c++ (mostly inside a library) and vice visa. 

## Problem
If your Golang program wants to call some APIs implemented in a C/C++ library, such as opencv/dlib, 
there are some solutions and all of them are very straightforward. But if your library is an event-driven style which means a lot of
callbacks are needed, the problem is then more complicated.

Here is the problem needs to be solved:
A golang program calls a c/c++ library with a callback fuction pointer as one of the parameters, the c/c++ api (inside the library of course)
is triggered and calls the golang callback function.

## Solution
### make a c++ lib
```
the clib folder is used to generate a c++ library
it is very simple:

class CppFoo
{
public:
    void CppNoParameter();
    void CppIntParameter(int i);
    void CppStringParameter(std::string& s);
    void CppFuncParameter(callback1 f);
};

The file clib.cpp is also straightforward to implement the class member functions.

```
### case1: use cgo to call a c++ api
#### the key trick is wrapper 
```
the folder gobinding is a wrapper for golang program.
$ ls gobinding
lib  Makefile  obj  src  wrapper

$ ls gobinding/src
gobinding.cpp  gobinding.h

$ ls gobinding/wrapper
wrapper.go

$ cat gobinding/wrapper/wrapper.go
/*
#include "../src/gobinding.h"
#include <stdlib.h>
#cgo LDFLAGS: -L${SRCDIR}/../../gobinding/lib -lgobinding -L${SRCDIR}/../../clib/lib -lclib
#cgo LDFLAGS: 
*/
import "C"

//"fmt"

func CppNoParameter() {
	C.CppNoParameter()
}

It is all about cgo features and is easy to find explaination.

$ cat cngo/main.go
package main

import (
	"cngo/gobinding/wrapper"
	"fmt"
)

func main() {
	fmt.Printf("inside main\n")
	wrapper.CppNoParameter()
}

$ ./run_cngo.sh
inside main
CppNoParameter triggered 

```

### case2: c++ function called by golang and a golang callback triggered
#### key trick is to avoid library wrapper!!!
```
there is an useful link: (https://github.com/draffensperger/go-interlang)

if you use wrapper library like the first case, you will be trapped in "symbol undefined" error. The weired thing is that cngo can sometimes find 
the callback function defined in Golang but it cannot find the callback function in most cases.

```
#### solution: go build
```
$ ls -ls cngo
total 40
8 -rw-r--r--  1 caiqingfeng  staff  360  7 18 13:28 Makefile
8 -rw-r--r--  1 caiqingfeng  staff  260  7 16 10:54 clib.h
8 -rw-r--r--  1 caiqingfeng  staff  247  7 16 10:50 gobinding.cpp
8 -rw-r--r--  1 caiqingfeng  staff  262  7 16 10:49 gobinding.h
8 -rw-r--r--  1 caiqingfeng  staff  305  7 16 10:56 main.go

$ cat cngo/Makefile
$(BINP)/cngo: main.go
        go  build -o $(BINP)/cngo

$ cat cngo/main.go
/*
#include "gobinding.h"
#include <stdlib.h>
#cgo LDFLAGS: -L${SRCDIR}/../clib/lib -lclib
*/
import "C"

$ cat cngo/gobinding.cpp
#include "_cgo_export.h"


the mystery file _cgo_export.h will be auto generated by cgo and be auto deleted too after "go build".

```


